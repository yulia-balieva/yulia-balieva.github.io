---
title: "Создание моделей линейной регрессии дневных потоков углекислого газа за летний период 2013 года по данным измерений методом турбулентной пульсации"
author: "Балиева Юлия"
date: '29 марта 2017 г '
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Назначение множественной регрессии состоит в анализе связи между несколькими независимыми переменными (называемыми также регрессорами и предикторами).
Аппроксимирующая модель подбирается в виде:
  
  Y=const+B1*X1+B2*X2 + ...+ Bk*Xk,

Величина Вj показывает, насколько в среднем изменяется признак Y при увеличении
соответствующего независимого признака Xj на единицу (шкалы его измерения)
при фиксированных значениях других признаков, входящих в уравнение регрессии.

Для определения независимых величин, от которых зависит поток углекислого газа мы воспользуемся функцией spirmen:
```{r }
spirmen = function(x,y) 
{x<-rank(x)
y<-rank(y)
s=0  
for (i in 1:length(x))
{s=s+(x[i]-y[i])^2
}
n<-length(x)
p=1-(6*s)/(n*(n-1)*(n+1))
return(p)
}
```


Коэффициент ранговой корреляции Спирмена - это непараметрический метод, который используется с целью статистического изучения связи между явлениями.
В этом случае определяется фактическая степень параллелизма между двумя количественными рядами изучаемых признаков и дается оценка тесноты 
установленной связи с помощью количественно выраженного коэффициента.

Для начала необходимо взять данные из файла "eddypro.csv" и запаисать их в таблицу:
```{r }
setwd ("D:/Group_126/Balieva/yulia-balieva.github.io")  
dt=read.csv("eddypro.csv", header = TRUE, sep ="," ) 
```
  


Так как среди данных попадаются значения явно не имеющие смысла такие как (-9999), мы уберем их из нашей таблицы:
```{r }
dt[dt == -9999] = NA
```


Так же уберем из таблицы столбцы, которые не являются числовыми:
```{r }
dt_main<-dt[,c(-1,-2,-3,-30,-35,-70,-88:-99)]
```


По условию задачи нам необходимы данные только летних месяцев, это означает, что нам нужны только те строчки из таблицы где значение DOY изменяется
от 152(1 июня) до 244(1 сентября), так как неравенство строгое:
```{r }
dt<-dt_main[dt_main$DOY>152 & dt_main$DOY<244,c(1:ncol(dt_main))]
```


Так же по условию задачи нам нужны данные дневных потоков. Дневное время считается от 12 00 до 18 00. Мы заполняем вектор I значениями тех строк, 
где дробная часть значений DOY изменяется от 0.5(12/24 суток) до 0.75(18/24 суток):
```{r }
I<-c()
for (i in 1:length(dt[,1]))
{
  if (round(dt$DOY[i],0)-dt$DOY[i]<0.5 & round(dt$DOY[i],0)-dt$DOY[i]>0.25)
  {
    I<-c(I,i)
  }
}
```


И оставим из таблицы dt строки с номерами из вектора I:
```{r }
dt<-dt[c(I),]
```


Вернемся к выбору независимых переменных.Посчитаем коэффициент Спирмена для каждого столбца из таблицы со столбцом co2_flux и запишем их значения в вектор k.
Столбец co2_flux имеет номер 14.
```{r }
k<-c()
for (i in 1: ncol(dt))
{
  k<-c(k,spirmen(dt[,i],dt[,14]))  
}
```

Вектор n нужен для сохранения номеров нужных нам столбцов, первый из них наша зависимая переменная co2_flux:
```{r cars}
n<-c(14)
```


Для определения тесноты связи между столбцами, положим что высокая степень корреляции наступает когда коэффициент Спирмена больше 0.75.
Опять же необходимо  запомнить порядковые номера коэффициентов в векторе, значения которых лежат в интервалах от 0.75 до 1 и от (-1) до (-0.75) 
для выделения нужных строк из таблицы:
```{r }
for (i in 1:length(k))
{
  if ((k[i]>0.75 & k[i]<1) | (k[i]>(-1) & k[i]<(-0.75)))
  {
    n<-c(n,i)
  }
  
}
n
```


Сохраним искомые нам данные в таблицу dt_1:
```{r }
dt_1<-dt[c(n)]
```


Посмотрим имена наших независимых переменных:
```{r }
names(dt_1)
```


Для получения линейных регрессионных уравнений в R существует функция lm. 
В данном случае мы строим линейную регрессионную модель для зависимости co2_flux от переменных, которые мы получили ранее:
```{r }
model1 = lm(co2_flux~bowen_ratio+qc_co2_flux+un_co2_flux + w.co2_cov, data =dt_1);
```
 

Используем данные дисперисонного анализа, применив команду anova()(ANOVA - Analysis of Variance) на нашу модель, для сравнения различий между большой объединяющей 
группой и ее отдельными подгруппами:
```{r }
anova(model1)
```
Значения Pr(>F) говорит нам о том, что вероятность нулевой гипотезы равна нулю, а значит наша расчитанная модель является статистически достоверной.

Построем новую модель с учетом того что наши независимые переменные могут между друг другом коррелировать, для этого найдем их коэффициенты корреляции друг с другом. Но так как среди значений в таблице присутствуют NA, то расчет коэффициентов невозможен. Поэтому удалим из таблицы те строки, где появляются значения NA:
```{r }
for (j in 1:4 )  
 {II<-c()
 for (i in 1:length(dt_1[,j]))
 {
   if (is.na(dt_1[i,j]))
   {
     II<-c(II,i)
     dt_2<-dt_1[-c(II),]
   }
 }
 }
 cor(dt_2)
```
Мы видим что среди всех переменных отлично коррелируют только переменные un_co2_flux и w.co2_cov, поэтому оставим лишь одну из них - un_co2_flux и построем новую модель:
```{r }
model2= lm(co2_flux~bowen_ratio+qc_co2_flux+un_co2_flux, data =dt_1);
```

До этого мы исходили из того, что каждая из независимых переменных не влияет на другую. Построем модель где учитывается их взаимодействие:
```{r }
model3= lm(co2_flux~(bowen_ratio+qc_co2_flux+un_co2_flux)^2, data =dt_1); 
```

Воспользуемся дисперсионным анализом чтобы посмотреть какая из моделей получилась точнее:
```{r }
anova( model1, model2,model3)
```
По значению  Pr(>F)=5.778e-09 мы видим что вторая модель точнее всех описывает наши данные

```{r , echo=FALSE}
plot(model2)
```
Первый и третий графики - Residuals vs Fitted и Scale-Location показывают зависимость отклонений от предсказанных моделью значений. Если на графике можно проследить хоть какую-то зависимость, 
 то это означает, что отклонения не случайны и существует еще какой-то фактор воздействующий на изучаемую зависимую переменную, а значит мы должны усложнить нашу модель.
 
 Второй график Normal Q-Q показывает распределение отклонений по квантилям. Чем ближе распределение к линейному, тем больше шанс того, что наши отклонения распределены нормально.
 В нашем случае мы видим, что прямая достаточно хорошо описывает нашу кривую, а значит можно говорить что величины распределены нормально.
 
 С помощью последнего графика вы можете определить точки, которые сильно отличаются от остальных и тем самым приводят к сильным отклонениям в модели. На графике прерывной линией 
 показана зона при выходе точек за пределы которой стоит обратить на них пристальное внимание. Если такие точки имеются, то следует создать альтернативный набор данных, без этих точек, 
 построить новую модель для уже для альтернативного набора данных и выбрать лучшую.
 Мы видим что все наши точки лежат внутри этой области.

Проведем анализ полученной модели:
Модель тем лучше чем ближе к 0 сумма остатков:
```{r }
sum(resid(model2))
```
Получим интервал для заданной точности:
```{r }
confint(model2)
```

Это означает, что мы можем с 95% вероятностью утверждать, что значение βi находится в данном нам интервале. Например для un_co2_flux коэффициент β с 95% 
  вероятностью находится в интервале от (1.102160512) до (1.104951957).
Получим общую информацию по модели:
```{r }
summary(model2)
```
